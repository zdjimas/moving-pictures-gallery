 <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KZAK • Frasier-Style Free Radio without the talking</title>
<style>
  :root{
    --ink:#e6e9ef; --muted:#9aa4b2; --brand:#89b4fa; --accent:#a6e3a1; --danger:#f38ba8;
    --card:#151a29; --line:#22324d; --shadow:0 18px 50px rgba(0,0,0,.45);
    --logo-size: 120px;            /* Frasier logo size (resizable) */
    --art-size: 180px;             /* Story panel artwork size */
    --lobby-arrow-size: 32px;      /* Return-to-Lobby arrow size */
  }

  html, body { height:100%; }
  body{
    margin:0; color:var(--ink);
    background:#0b1020 url("Media/RadioMusicListening.jpg") center/cover no-repeat fixed;
    position:relative;
  }
  /* Lighter overlay than old grey look */
  body::before{
    content:""; position:fixed; inset:0; z-index:-1;
    background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.65));
    backdrop-filter: blur(2px);
  }

  .wrap{
    max-width: 1100px;
    margin: clamp(16px, 3vw, 28px) auto;
    padding: 0 16px 48px;
  }

  /* Header */
  header{
    display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;
  }
  .title{
    display:flex; align-items:center; gap:14px;
  }
  .logo{
    width: var(--logo-size); height: var(--logo-size); object-fit: contain;
    filter: drop-shadow(0 10px 25px rgba(0,0,0,.5));
  }
  h1{ margin:0; font-size:clamp(20px, 3.2vw, 34px); letter-spacing:.2px; }

  /* Return to Lobby (bigger arrow) */
  .lobby-btn{
    display: inline-flex; align-items: center; gap: .6rem;
    padding: .7rem 1rem; border-radius: 999px;
    border: 1px solid var(--line);
    background: rgba(0,0,0,.35);
    backdrop-filter: blur(6px);
    color: var(--ink);
    box-shadow: var(--shadow);
    cursor: pointer; text-decoration: none;
    transition: transform .1s ease, background .2s ease, border-color .2s ease;
    font-weight:600;
  }
  .lobby-btn:hover{ transform: translateY(-1px); background: rgba(0,0,0,.45); }
  .lobby-btn:active{ transform: translateY(0); }
  .lobby-arrow{ width: var(--lobby-arrow-size); height: var(--lobby-arrow-size); fill: currentColor; }

  /* Player Card */
  .card{
    background: rgba(10,14,26,.55);
    border: 1px solid rgba(255,255,255,.08);
    box-shadow: 0 25px 70px rgba(0,0,0,.45);
    border-radius: 16px;
    overflow: clip;
  }
  .card-body{ padding: 18px; display:grid; gap: 14px; }

  .row{
    display:flex; align-items:center; gap:12px; flex-wrap:wrap;
  }
  .pill{
    display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem;
    border-radius:999px; background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.1);
    font-weight:600;
  }
  .onair-dot{
    width: 12px; height: 12px; border-radius: 999px;
    background: #333;
    box-shadow: inset 0 0 4px rgba(0,0,0,.6);
    transition: background .2s ease, box-shadow .2s ease;
  }
  .onair.on .onair-dot{
    background: var(--danger);
    box-shadow: 0 0 12px rgba(243,139,168,.9), 0 0 30px rgba(243,139,168,.5);
  }

  .controls{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .btn{
    padding:.55rem .9rem; border-radius:12px; border:1px solid var(--line);
    background: rgba(0,0,0,.3); color:var(--ink); cursor:pointer; font-weight:600;
  }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }
  .btn.primary{ background: rgba(60,90,160,.5); border-color:#4060a0; }
  .tog.on{ outline:2px solid var(--brand); }

  .scrub{
    display:grid; gap:6px; width:100%;
  }
  .range{
    appearance:none; width:100%; height:6px; border-radius:999px; background: rgba(255,255,255,.18); outline:none;
  }
  .range::-webkit-slider-thumb{ appearance:none; width:16px; height:16px; border-radius:999px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.4); }
  .timebar{
    display:flex; justify-content:space-between; font-size:.9rem; color:var(--muted);
  }

  .meta{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap; color:var(--muted);
  }
  .counter{ font-weight:700; color:var(--ink); }

  /* Story panel */
  .story{
    display:grid; grid-template-columns: var(--art-size) 1fr; gap:16px; align-items:start;
    border-top:1px solid rgba(255,255,255,.08); padding-top:14px;
  }
  .art{
    width: var(--art-size); height: var(--art-size);
    object-fit: cover; border-radius:12px; border:1px solid rgba(255,255,255,.1);
    background: #0b0b0b;
  }
  .story h3{ margin:.25rem 0 .5rem; font-size:1.05rem; }
  .story p{ margin:.25rem 0; color:#d7dbe3; line-height:1.35; }
  .story small{ color: var(--muted); }

  /* Playlist */
  .list{
    max-height: 280px; overflow:auto; padding:8px; border-top:1px solid rgba(255,255,255,.08);
  }
  .track{
    display:flex; align-items:center; gap:10px; padding:8px 10px; border-radius:10px; cursor:pointer;
  }
  .track:hover{ background: rgba(255,255,255,.06); }
  .track.active{ background: rgba(137,180,250,.16); outline:1px solid rgba(137,180,250,.35); }
  .tidx{ min-width:28px; text-align:right; color:var(--muted); font-variant-numeric: tabular-nums; }

  /* Exit overlay (pre-roll) */
  #exitOverlay{
    position: fixed; inset: 0; z-index: 9999; display: none; place-items: center;
    background:
      radial-gradient(1200px 600px at 50% 10%, rgba(0,0,0,.35), rgba(0,0,0,.75)),
      rgba(0,0,0,.7);
  }
  #exitOverlay.show{ display: grid; }
  #exitOverlay video{
    max-width: min(100vw, 1200px); max-height: 100vh; width: 100%; height: auto;
    outline: none; border-radius: 12px; box-shadow: 0 30px 90px rgba(0,0,0,.6); background:#000;
  }
  #exitOverlay .overlay-ui{
    position: absolute; inset: 0; display: flex; align-items: flex-end; justify-content: space-between;
    padding: 1rem 1.25rem; pointer-events: none;
  }
  #exitOverlay .overlay-text{
    color: #e6e9ef; font-size: 1rem; opacity: .85; pointer-events: none; text-shadow: 0 2px 14px rgba(0,0,0,.7);
  }
  #skipExit{
    pointer-events: auto; padding: .5rem .9rem; border-radius: 999px;
    border: 1px solid rgba(255,255,255,.25); background: rgba(20,20,20,.55);
    color: #e6e9ef; font-weight: 600; box-shadow: 0 8px 30px rgba(0,0,0,.4);
  }
  #skipExit:hover{ background: rgba(20,20,20,.7); }

  /* Hover preview visual cue (optional) */
  .previewing { box-shadow: 0 0 18px rgba(166, 227, 161, .45) !important; }

  /* Utilities */
  .spacer{ flex:1; }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <img src="Media/frasier.png" alt="Frasier radio logo" class="logo" />
        <h1>KZAK • Frasier-Style Free Radio without the talking</h1>
      </div>

      <!-- Return to Lobby (plays exit video first) -->
      <button id="returnToLobby" class="lobby-btn" aria-label="Return to Lobby" title="Return to Lobby">
        <svg class="lobby-arrow" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M12 4l1.41 1.41L8.83 10H20v2H8.83l4.58 4.59L12 18l-8-8 8-8z"/>
        </svg>
        <span class="lobby-label">Return to Lobby</span>
      </button>
    </header>

    <main class="card">
      <div class="card-body">

        <!-- Row: ON AIR + Share -->
        <div class="row">
          <div id="onAir" class="pill onair" aria-live="polite">
            <span class="onair-dot" aria-hidden="true"></span>
            <span>ON AIR</span>
          </div>
          <div class="spacer"></div>
          <button id="shareBtn" class="btn" aria-label="Share this station with current track">Share</button>
        </div>

        <!-- Row: Big transport controls -->
        <div class="row controls">
          <button id="prevBtn" class="btn">⏮ Prev</button>
          <button id="playBtn" class="btn primary">Start Station</button>
          <button id="nextBtn" class="btn">⏭ Next</button>
          <button id="loopBtn" class="btn tog" aria-pressed="false">Loop</button>
          <button id="shuffleBtn" class="btn tog" aria-pressed="false">Shuffle</button>
          <button id="muteBtn" class="btn tog" aria-pressed="false">Mute</button>
          <label class="pill" title="Volume">
            <span>Vol</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" style="vertical-align:middle; width:140px; margin-left:.5rem;">
          </label>
        </div>

        <!-- Scrubber -->
        <div class="scrub">
          <input id="seek" class="range" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
          <div class="timebar">
            <span id="elapsed">0:00</span>
            <span id="remaining">-0:00</span>
          </div>
        </div>

        <!-- Meta -->
        <div class="meta">
          <div><strong id="trackTitle">—</strong></div>
          <div class="spacer"></div>
          <div>Track <span id="counter" class="counter">0 / 0</span></div>
        </div>

        <!-- Story Panel -->
        <section class="story" aria-label="Song story panel">
          <img id="storyImg" class="art" src="Media/default.jpg" alt="Artwork">
          <div>
            <h3 id="storyTitle">Song Story</h3>
            <p id="storyText">Under Construction… stories and artwork are being added for each track.</p>
            <small id="storyAlt"></small>
          </div>
        </section>

        <!-- Playlist -->
        <div id="playlist" class="list" role="listbox" aria-label="Playlist"></div>

        <!-- Hidden audio -->
        <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>

        <!-- Hover Sound toggle -->
        <div class="row" style="margin-top:6px;">
          <label class="pill" title="Enable/disable hover preview">
            <input id="hoverSoundToggle" type="checkbox" checked style="margin-right:.5rem;">
            Hover Sound
          </label>
          <small style="color:var(--muted);">Hover/press the logo or artwork to hear Frasier jokes (pauses station, resumes on exit).</small>
        </div>

        <!-- Hidden hover preview audio (Frasier jokes) -->
        <audio id="hoverPreview" preload="auto" loop src="Media/FrasierSnappyComebacks.mp3"></audio>

      </div>
    </main>

    <footer style="margin-top:10px; color:var(--muted); font-size:.9rem; text-align:center;">
      Copyright 2025: zdjimas and cjmurphy creators and authors
    </footer>
  </div>

  <!-- Exit Pre-roll Overlay (plays before returning to lobby) -->
  <div id="exitOverlay" aria-hidden="true">
    <video id="exitVideo" playsinline preload="auto">
      <source src="Media/FrasierExit.mp4" type="video/mp4" />
    </video>
    <div class="overlay-ui">
      <div class="overlay-text">Leaving the Radio Room…</div>
      <button id="skipExit" class="btn" aria-label="Skip and return to Lobby">Skip</button>
    </div>
  </div>

<script>
(function(){
  /* =========================
     Utility
  ========================== */
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const pad = n => n.toString().padStart(2,'0');
  const fmt = secs => {
    if (!isFinite(secs)) return '0:00';
    const m = Math.floor(secs/60);
    const s = Math.floor(secs%60);
    return `${m}:${pad(s)}`;
  };
  const pathToUrl = (p) => encodeURI(p).replace(/#/g, '%23');

  /* =========================
     Config & State
  ========================== */
  const DEFAULT_STORY = {
    img: 'Media/default.jpg',
    alt: 'Default artwork',
    story: 'Under Construction… stories and artwork are being added for each track.'
  };

  const BREAKS_DIR = 'MediaBreaks/';
  const BREAK_FILES = [
    'ID1.mp3','ID2.mp3','ID3.mp3','ID4.mp3' // replace with actual break file names if needed
  ];

  const LOBBY_URL = '../index.html'; // adjust if lobby path differs
  const EXIT_VIDEO_TIMEOUT_MS = 30000;

  /* =========================
     PLAYLIST
     >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
     BEGIN PLAYLIST — PASTE YOUR 113-TRACK ARRAY HERE (KEEP DUPES IF INTENDED)
     Each item: { title, file, img?, alt?, story? }
     Example override fields shown below. If you paste your full array, remove the fallback.
     <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
  ========================== */
  let PLAYLIST = [
    { title: "Sample 1", file: "Media/The Greatest Debate Ever.mp3",
      img: "Media/default.jpg", alt: "Debate artwork",
      story: "Demo track. Replace this fallback by pasting your full 113-track array here." },
    { title: "Sample 2", file: "Media/Dogs (Remix).mp3" }
  ];
  // << END of PASTE area >>

  if (window.PLAYLIST && Array.isArray(window.PLAYLIST) && window.PLAYLIST.length) {
    PLAYLIST = window.PLAYLIST;
  }

  /* =========================
     Elements
  ========================== */
  const audio = $('#audio');
  const onAir = $('#onAir');
  const playBtn = $('#playBtn');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const loopBtn = $('#loopBtn');
  const shuffleBtn = $('#shuffleBtn');
  const muteBtn = $('#muteBtn');
  const vol = $('#vol');
  const seek = $('#seek');
  const elapsedEl = $('#elapsed');
  const remainingEl = $('#remaining');
  const titleEl = $('#trackTitle');
  const counterEl = $('#counter');
  const listEl = $('#playlist');
  const storyImg = $('#storyImg');
  const storyTitle = $('#storyTitle');
  const storyText = $('#storyText');
  const storyAlt = $('#storyAlt');
  const shareBtn = $('#shareBtn');

  // Exit overlay
  const exitOverlay = $('#exitOverlay');
  const exitVideo = $('#exitVideo');
  const skipExit = $('#skipExit');
  const returnBtn = $('#returnToLobby');

  // Hover preview
  const hoverToggle = $('#hoverSoundToggle');
  const previewAudio = $('#hoverPreview');
  const logoEl = $('.logo');

  /* =========================
     State
  ========================== */
  let index = 0;
  let order = PLAYLIST.map((_, i) => i); // track order (shuffles except current pinned)
  let isShuffle = false;
  let isLoop = false;
  let breakCounter = 0; // play a break after 3 songs
  let isPlayingBreak = false;

  /* =========================
     Init from deep link ?t=#
  ========================== */
  const params = new URLSearchParams(location.search);
  const startAt = parseInt(params.get('t'),10);
  if (!isNaN(startAt) && startAt >= 0 && startAt < PLAYLIST.length) {
    index = startAt;
  }

  /* =========================
     Build Playlist UI
  ========================== */
  function buildList(){
    listEl.innerHTML = '';
    PLAYLIST.forEach((t,i) => {
      const item = document.createElement('div');
      item.className = 'track';
      item.setAttribute('role','option');
      item.dataset.idx = i;
      item.innerHTML = `<div class="tidx">${i+1}</div><div class="tt">${t.title || 'Untitled'}</div>`;
      item.addEventListener('click', () => {
        index = i;
        breakCounter = 0; // reset cadence when user jumps
        load(index, true);
      });
      listEl.appendChild(item);
    });
    updateActive();
  }

  function updateActive(){
    $$('.track').forEach(el => el.classList.toggle('active', Number(el.dataset.idx) === index));
  }

  /* =========================
     Load Track (+story)
  ========================== */
  function load(i, autoplay=false){
    const track = PLAYLIST[i];
    if (!track) return;
    const src = pathToUrl(track.file);
    audio.src = src;
    titleEl.textContent = track.title || 'Untitled';
    counterEl.textContent = `${i+1} / ${PLAYLIST.length}`;

    // Story panel: per-song overrides or defaults
    const img = track.img || DEFAULT_STORY.img;
    const alt = track.alt || DEFAULT_STORY.alt;
    const story = track.story || DEFAULT_STORY.story;
    storyImg.src = img; storyImg.alt = alt;
    storyTitle.textContent = track.title || 'Song Story';
    storyText.textContent = story;
    storyAlt.textContent = alt ? `(${alt})` : '';

    updateActive();
    if (autoplay) play();
  }

  /* =========================
     Play / Pause
  ========================== */
  function play(){
    audio.play().then(()=>{
      playBtn.textContent = 'Pause Station';   // label fixed by design
      onAir.classList.add('on');
    }).catch(()=>{
      playBtn.textContent = 'Start Station';
      onAir.classList.remove('on');
    });
  }
  function pause(){
    audio.pause();
    playBtn.textContent = 'Start Station';
    onAir.classList.remove('on');
  }

  playBtn.addEventListener('click', ()=>{
    if (audio.paused) play(); else pause();
  });

  prevBtn.addEventListener('click', ()=>{
    if (isPlayingBreak) return; // ignore during break
    index = (index - 1 + PLAYLIST.length) % PLAYLIST.length;
    breakCounter = 0;
    load(index, true);
  });

  nextBtn.addEventListener('click', ()=>{
    if (isPlayingBreak) return;
    advanceTrack(true);
  });

  loopBtn.addEventListener('click', ()=>{
    isLoop = !isLoop;
    loopBtn.classList.toggle('on', isLoop);
    loopBtn.setAttribute('aria-pressed', String(isLoop));
  });

  shuffleBtn.addEventListener('click', ()=>{
    isShuffle = !isShuffle;
    shuffleBtn.classList.toggle('on', isShuffle);
    shuffleBtn.setAttribute('aria-pressed', String(isShuffle));
    if (isShuffle){
      // Shuffle, but pin current index at its place
      const cur = index;
      const rest = order.filter(i => i !== cur);
      for (let i=rest.length-1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [rest[i], rest[j]] = [rest[j], rest[i]];
      }
      order = [cur, ...rest];
    } else {
      order = PLAYLIST.map((_,i)=>i);
    }
  });

  muteBtn.addEventListener('click', ()=>{
    audio.muted = !audio.muted;
    muteBtn.classList.toggle('on', audio.muted);
    muteBtn.setAttribute('aria-pressed', String(audio.muted));
  });
  vol.addEventListener('input', ()=>{ audio.volume = Number(vol.value); });

  /* =========================
     Scrubber
  ========================== */
  audio.addEventListener('timeupdate', ()=>{
    const p = (audio.currentTime / (audio.duration||1));
    seek.value = Math.floor(p*1000);
    elapsedEl.textContent = fmt(audio.currentTime);
    remainingEl.textContent = `-${fmt((audio.duration||0) - audio.currentTime)}`;
  });
  seek.addEventListener('input', ()=>{
    const t = (Number(seek.value)/1000) * (audio.duration||0);
    if (isFinite(t)) audio.currentTime = t;
  });

  /* =========================
     Ended -> Breaks / Next
  ========================== */
  audio.addEventListener('ended', ()=>{
    if (isPlayingBreak){
      isPlayingBreak = false;
      onAir.classList.remove('on'); // will toggle on when song resumes
      advanceTrack(true);
      return;
    }
    // finished a song
    breakCounter++;
    if (!isLoop && (breakCounter >= 3) && !audio.muted){
      // play a random station ID break (skip if loop; obey mute/volume)
      const pick = BREAK_FILES[Math.floor(Math.random()*BREAK_FILES.length)];
      if (pick){
        isPlayingBreak = true;
        onAir.classList.add('on'); // ON AIR remains on during break
        audio.src = pathToUrl(BREAKS_DIR + pick);
        audio.play().catch(()=>{ isPlayingBreak = false; advanceTrack(true); });
        breakCounter = 0;
        return;
      }
    }
    // otherwise next track
    if (isLoop){
      load(index, true);
    } else {
      advanceTrack(true);
    }
  });

  function advanceTrack(autoplay){
    if (isShuffle){
      // find current in order and step to next
      const pos = order.indexOf(index);
      const nextPos = (pos + 1) % order.length;
      index = order[nextPos];
    } else {
      index = (index + 1) % PLAYLIST.length;
    }
    load(index, autoplay);
  }

  /* =========================
     Share deep link (?t=index)
  ========================== */
  shareBtn.addEventListener('click', async ()=>{
    const url = new URL(location.href);
    url.searchParams.set('t', index);
    const shareData = { title: 'KZAK Radio Room', text: PLAYLIST[index]?.title || 'KZAK', url: url.toString() };
    try{
      if (navigator.share) { await navigator.share(shareData); }
      else {
        await navigator.clipboard.writeText(url.toString());
        shareBtn.textContent = 'Link copied!';
        setTimeout(()=> shareBtn.textContent = 'Share', 1400);
      }
    }catch{
      await navigator.clipboard.writeText(url.toString());
      shareBtn.textContent = 'Link copied!';
      setTimeout(()=> shareBtn.textContent = 'Share', 1400);
    }
  });

  /* =========================
     Hover Preview (Frasier jokes)
     - Pauses station on hover/press of logo or artwork
     - Plays looped preview, then resumes station on exit
  ========================== */
  const targets = [storyImg, logoEl].filter(Boolean);
  let wasPlaying = false;
  let hoverActive = false;
  let hoverIntentTimer = null;
  const HOVER_DELAY_MS = 120;

  function canPreview(){
    return hoverToggle ? hoverToggle.checked : true;
  }

  async function startPreview(target){
    if (hoverActive || !canPreview()) return;
    hoverActive = true;
    target && target.classList && target.classList.add('previewing');

    try { wasPlaying = !audio.paused; } catch { wasPlaying = false; }
    try { if (wasPlaying) pause(); } catch {} // uses pause() to keep UI consistent
    try {
      previewAudio.currentTime = 0;
      await previewAudio.play();
    } catch(e){
      stopPreview(target); // if blocked, bail cleanly
    }
  }

  function stopPreview(target){
    if (!hoverActive) return;
    hoverActive = false;
    try { previewAudio.pause(); } catch {}
    target && target.classList && target.classList.remove('previewing');

    if (wasPlaying){
      audio.play().then(()=> onAir.classList.add('on'))
                  .catch(()=> {/* leave UI paused if resume fails */});
    }
  }

  function bindTarget(el){
    if (!el) return;

    // Desktop hover with small intent delay
    el.addEventListener('mouseenter', ()=>{
      clearTimeout(hoverIntentTimer);
      hoverIntentTimer = setTimeout(()=> startPreview(el), HOVER_DELAY_MS);
    });
    el.addEventListener('mouseleave', ()=>{
      clearTimeout(hoverIntentTimer);
      stopPreview(el);
    });

    // Mobile press-and-hold
    el.addEventListener('touchstart', ()=>{
      clearTimeout(hoverIntentTimer);
      hoverIntentTimer = setTimeout(()=> startPreview(el), HOVER_DELAY_MS);
    }, {passive:true});
    el.addEventListener('touchend', ()=>{
      clearTimeout(hoverIntentTimer);
      stopPreview(el);
    }, {passive:true});
    el.addEventListener('touchcancel', ()=>{
      clearTimeout(hoverIntentTimer);
      stopPreview(el);
    }, {passive:true});

    // Keyboard accessibility
    el.setAttribute('tabindex','0');
    el.addEventListener('focus', ()=>{
      clearTimeout(hoverIntentTimer);
      hoverIntentTimer = setTimeout(()=> startPreview(el), HOVER_DELAY_MS);
    });
    el.addEventListener('blur', ()=>{
      clearTimeout(hoverIntentTimer);
      stopPreview(el);
    });
    el.addEventListener('keydown', (e)=>{
      if (e.code === 'Space' || e.code === 'Enter'){
        e.preventDefault();
        if (hoverActive) stopPreview(el); else startPreview(el);
      }
    });
  }
  targets.forEach(bindTarget);

  // Safety: if station play/pause occurs during preview, reconcile states
  audio.addEventListener('play', ()=>{
    if (hoverActive) { try { previewAudio.pause(); } catch{} }
    onAir.classList.add('on');
  });
  audio.addEventListener('pause', ()=>{
    if (!hoverActive) onAir.classList.remove('on');
  });

  /* =========================
     Exit pre-roll -> lobby
  ========================== */
  function goLobby(){ window.location.href = LOBBY_URL; }

  async function playExitThenReturn(){
    try { if (!audio.paused) pause(); } catch(e){}
    // Also stop hover preview if active
    try { if (hoverActive) { previewAudio.pause(); hoverActive=false; } } catch(e){}

    exitOverlay.classList.add('show');
    exitOverlay.setAttribute('aria-hidden','false');
    try { exitVideo.currentTime = 0; } catch(e){}

    const cleanup = ()=>{
      exitOverlay.classList.remove('show');
      exitOverlay.setAttribute('aria-hidden','true');
      try{ exitVideo.pause(); }catch(e){}
      document.removeEventListener('keydown', onKey);
      exitVideo.removeEventListener('ended', onEnded);
      exitVideo.removeEventListener('error', onError);
    };
    const onEnded = ()=>{ cleanup(); goLobby(); };
    const onError = ()=>{ cleanup(); goLobby(); };
    const onKey = (e)=>{ if (e.key === 'Escape'){ e.preventDefault(); cleanup(); goLobby(); } };

    document.addEventListener('keydown', onKey);
    exitVideo.addEventListener('ended', onEnded, { once:true });
    exitVideo.addEventListener('error', onError, { once:true });

    let played = false;
    try { await exitVideo.play(); played = true; } catch(e){ cleanup(); goLobby(); return; }

    if (played){
      setTimeout(()=>{ if (!exitVideo.paused && !exitVideo.ended){ cleanup(); goLobby(); } }, EXIT_VIDEO_TIMEOUT_MS);
    }
  }

  if (returnBtn){
    returnBtn.addEventListener('click', (e)=>{ e.preventDefault(); playExitThenReturn(); });
  }
  if (skipExit){
    skipExit.addEventListener('click', (e)=>{ e.preventDefault(); goLobby(); });
  }

  /* =========================
     Start
  ========================== */
  audio.volume = Number(vol.value);
  buildList();
  load(index, false);
})();
</script>
</body>
</html>
