 <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KZAK ‚Ä¢ Frasier-Style Free Radio without the talking</title>
<style>
  :root{
    --ink:#e6e9ef; --muted:#9aa4b2; --brand:#89b4fa; --accent:#a6e3a1; --danger:#f38ba8;
    --card:#151a29; --line:#22324d; --shadow:0 18px 50px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#0a0e1a;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* Lighter overlay so the background image pops more */
  .bg{
    position:fixed; inset:0; pointer-events:none;
    background:
      linear-gradient(180deg, rgba(10,14,26,.35), rgba(10,14,26,.70)),
      url('Media/RadioMusicListening.jpg') center/cover no-repeat;
    opacity:.38; /* was ~.28 with heavier gradient ‚Äî now brighter overall */
    filter:saturate(.95);
  }

  .wrap{position:relative;max-width:1200px;margin:0 auto;padding:22px 18px 80px}

  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .header-logo{height:52px;border-radius:8px}
  h1{font-size:clamp(22px,3.4vw,36px);margin:0;line-height:1.15}
  .return{margin-left:auto;text-decoration:none}

  /* Restored ON AIR pill ‚Äì bigger, highly visible, exact on/off */
  .onair{
    display:inline-flex; align-items:center; gap:10px;
    background:#101a2d; border:1px solid var(--line);
    padding:10px 16px; border-radius:999px; font-weight:700;
    text-transform:uppercase; letter-spacing:.08em; font-size:14px;
  }
  .lamp{
    width:14px; height:14px; border-radius:50%;
    background:#444; box-shadow:0 0 4px #000 inset; transition:all .25s;
  }
  .onair.active .lamp{ background:#ff3b30; box-shadow:0 0 10px #ff3b30, 0 0 2px #ff3b30 inset; }

  .grid{display:grid;grid-template-columns:1fr min(460px,44%);gap:18px}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)}
  .controls{padding:16px}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  button{background:#0f1628;border:1px solid var(--line);color:var(--ink);padding:10px 12px;border-radius:12px;cursor:pointer}
  button:hover{border-color:#3a5279}
  .title{font-weight:600;margin-top:6px}
  .scrub{display:flex;align-items:center;gap:10px;margin-top:10px}
  input[type="range"]{width:100%}
  .meta{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:6px}

  aside.playlist{display:flex;flex-direction:column}
  aside h3{margin:14px 16px 8px;font-size:14px;color:var(--muted)}
  .list{height:430px;overflow:auto;-webkit-overflow-scrolling:touch;border-top:1px solid var(--line);border-bottom:1px solid var(--line)}
  .track{display:flex;gap:10px;align-items:flex-start;padding:10px 14px;border-bottom:1px solid var(--line);cursor:pointer}
  .track:hover{background:#0f1628}
  .idx{font-variant-numeric:tabular-nums;color:var(--muted);min-width:32px}
  .now{color:var(--accent)}
  .footer{padding:12px 16px;color:var(--muted);font-size:12px}

  .creators{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .card{padding:16px}
  .creator{display:flex;gap:12px;align-items:flex-start}
  .portrait{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid var(--line)}
  .small{color:var(--muted);font-size:12px}

  @media (max-width:900px){ .grid{grid-template-columns:1fr} .creators{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="bg" aria-hidden="true"></div>
<div class="wrap">
  <header>
    <img class="header-logo" src="Media/frasier.png" alt="Frasier badge" />
    <h1>KZAK ‚Ä¢ Frasier-Style Free Radio without the talking</h1>
    <a class="return onair" href="../index.html" aria-label="Return to Lobby">‚Üê Lobby</a>
    <span id="onAir" class="onair" aria-live="polite">ON AIR <span class="lamp" id="onLamp"></span></span>
  </header>

  <section class="grid">
    <!-- Transport & timeline -->
    <div class="panel controls" role="region" aria-label="Player controls">
      <div class="row">
        <button id="btnPrev" aria-label="Previous track">‚èÆÔ∏é Prev</button>
        <button id="btnPlay" aria-label="Play">‚ñ∂Ô∏é Start Station</button>
        <button id="btnNext" aria-label="Next track">‚è≠Ô∏é Next</button>
        <button id="btnLoop" aria-label="Loop">‚ü≤ Loop</button>
        <button id="btnShuffle" aria-label="Shuffle">üîÄ Shuffle</button>
        <button id="btnMute" aria-label="Mute">üîá Mute</button>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" aria-label="Volume"/>
      </div>

      <div id="title" class="title" aria-live="polite">‚Äî</div>

      <div class="scrub">
        <span id="elapsed" aria-label="Elapsed">0:00</span>
        <input id="seek" type="range" min="0" max="100" value="0" aria-label="Seek"/>
        <span id="remaining" aria-label="Remaining">-0:00</span>
      </div>

      <div class="meta">
        <span id="meta">Not playing</span>
        <span id="counter" class="onair">track <span id="tpos">0</span> / <span id="ttotal">0</span></span>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnShare" aria-label="Share current track">Share</button>
      </div>

      <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>
    </div>

    <!-- Playlist -->
    <aside class="panel playlist" role="region" aria-label="Playlist">
      <h3>Playlist</h3>
      <div id="list" class="list" role="listbox" aria-label="Track list"></div>
      <div class="footer">Use headphones ‚Ä¢ Filenames are case-sensitive ‚Ä¢ Share copies a deep link to the current track</div>
    </aside>
  </section>

  <!-- Creators -->
  <section class="creators">
    <div class="panel card">
      <div class="creator">
        <img class="portrait" src="Media/ZachArt.jpeg" alt="zdjimas portrait" />
        <div>
          <strong>zdjimas</strong><div class="small">Concept, curation, engineering</div>
        </div>
      </div>
    </div>
    <div class="panel card">
      <div class="creator">
        <img class="portrait" src="Media/CJMURPHY.png" alt="cjmurphy portrait" />
        <div>
          <strong>cjmurphy</strong><div class="small">Composition, arrangement, sound design</div>
        </div>
      </div>
    </div>
  </section>
</div>
<script>
/* ===== Helpers ===== */
const pathToUrl = p => encodeURI(p).replace(/#/g,'%23');
const fmt = s => { if (!isFinite(s)) return '0:00'; const m=(s/60)|0, sec=(s%60)|0; return m+':'+(sec<10?'0':'')+sec; };
const pick = arr => arr[Math.floor(Math.random()*arr.length)];

/* ===== DOM ===== */
const audio = document.getElementById('audio');
const btnPrev = document.getElementById('btnPrev');
const btnPlay = document.getElementById('btnPlay');
const btnNext = document.getElementById('btnNext');
const btnLoop = document.getElementById('btnLoop');
const btnShuffle = document.getElementById('btnShuffle');
const btnMute = document.getElementById('btnMute');
const btnShare = document.getElementById('btnShare');
const vol = document.getElementById('vol');
const seek = document.getElementById('seek');
const title = document.getElementById('title');
const meta = document.getElementById('meta');
const list = document.getElementById('list');
const onAir = document.getElementById('onAir');
const onLamp = document.getElementById('onLamp');
const tpos = document.getElementById('tpos');
const ttotal = document.getElementById('ttotal');

/* ===== PLAYLIST ===== */
/* (unchanged ‚Äî keep your existing PLAYLIST array as-is) */
const PLAYLIST = [
  /* ‚Ä¶ your 80 tracks ‚Ä¶ */
];
ttotal.textContent = PLAYLIST.length;

/* ===== Station IDs ===== */
const BREAKS = [
  "MediaBreaks/AishaPatelYouarelisteningtoK-Z-A-K.wav",
  "MediaBreaks/AmyYouarelisteningtoK-ZACHt.mp3",
  "MediaBreaks/en-US-Journey-D-K_ZACH___where_the_f.wav",
  "MediaBreaks/en-US-Journey-DYouaretunedintoK-Z-A-Kb.mp3",
  "MediaBreaks/en-US-News-NThisiskZ-A-Kbringingyou.mp3"
];
const BREAKS_CFG = { enabled:true, mode:"everyN", n:3, prob:0.33 };

/* ===== State ===== */
let idx = 0;
let userScrubbing = false;
let isBreak = false;
let tracksSinceBreak = 0;
let isLoading = false;       // NEW: guard async races
let isShuffling = false;     // NEW: prevent re-entrancy

/* Make break audio more robust */
const breakAudio = new Audio();
breakAudio.crossOrigin = 'anonymous';

/* ===== UI helpers ===== */
function setOnAir(on){ onAir.classList.toggle('active', on); }
function pickBreakNow(){
  if (!BREAKS_CFG.enabled || audio.loop || BREAKS.length===0) return false;
  if (BREAKS_CFG.mode==="betweenAll") return true;
  if (BREAKS_CFG.mode==="everyN"){ tracksSinceBreak++; if (tracksSinceBreak>=BREAKS_CFG.n){ tracksSinceBreak=0; return true; } return false; }
  if (BREAKS_CFG.mode==="random") return Math.random() < BREAKS_CFG.prob;
  return false;
}
function currentMedia(){ return isBreak ? breakAudio : audio; }

/* ===== Playlist UI ===== */
function renderList(){
  list.innerHTML='';
  PLAYLIST.forEach((t,i)=>{
    const row=document.createElement('div');
    row.className='track';
    row.innerHTML=`<span class="idx">${String(i+1).padStart(2,'0')}</span>
                   <div><div>${t.title}</div><div class="small">${t.file.replace(/^Media\//,'')}</div></div>`;
    row.onclick=()=>{ cancelBreakIfAny(); load(i, /*autoplay=*/true); };
    list.appendChild(row);
  });
}
function markActive(){
  [...list.children].forEach((el,i)=>el.querySelector('.idx').classList.toggle('now', i===idx));
}

/* ===== Core playback ===== */
function load(i, autoplay=false){
  isLoading = true;
  idx = (i+PLAYLIST.length)%PLAYLIST.length;
  const tr = PLAYLIST[idx];
  audio.src = pathToUrl(tr.file);
  title.textContent = tr.title;
  meta.textContent = 'Queued';
  tpos.textContent = idx+1;
  markActive();
  const u=new URL(location); u.searchParams.set('t', idx); history.replaceState({},'',u);

  // Ensure scrubber resets during load
  seek.value = 0;
  document.getElementById('elapsed').textContent = '0:00';
  document.getElementById('remaining').textContent = '-0:00';

  const start = () => { isLoading = false; if (autoplay) play(); };
  if (audio.readyState >= 2) start(); else audio.onloadedmetadata = start;
}
function play(){
  // Always target the main program audio; if a break is playing, skip it.
  if (isBreak) { cancelBreakIfAny(); next(); return; }
  audio.play().catch(()=>{}); // user gesture already satisfied
}
function pause(){ currentMedia().pause(); }
function next(){ load(idx+1, /*autoplay=*/true); }
function prev(){ load(idx-1, /*autoplay=*/true); }

/* ===== Break handling ===== */
function cancelBreakIfAny(){
  if (isBreak){
    try { breakAudio.pause(); } catch {}
    isBreak = false;
  }
}

async function playBreakThenNext(){
  // If user toggled Loop, or we became busy, skip the break
  if (audio.loop) { next(); return; }

  isBreak = true;
  const prevTitle=title.textContent, prevMeta=meta.textContent;

  breakAudio.volume = audio.volume;
  breakAudio.muted  = audio.muted;
  const file = pick(BREAKS);
  title.textContent = "Station ID ‚Ä¢ KZAK";
  meta.textContent = file.replace(/^MediaBreaks\//,'');

  breakAudio.src = pathToUrl(file);

  // Robust fallbacks: if break fails to play, continue to the next track
  const goNext = () => { title.textContent=prevTitle; meta.textContent=prevMeta; isBreak=false; next(); };
  breakAudio.onerror = goNext;
  breakAudio.onended = goNext;

  try{
    await breakAudio.play();
  }catch{
    goNext();
  }
}

/* ===== Controls ===== */
btnPlay.onclick = ()=>{
  // If we‚Äôre in a break, treat Play/Pause as "skip the break"
  if (isBreak){ cancelBreakIfAny(); next(); return; }

  const el=currentMedia();
  el.paused ? el.play().catch(()=>{}) : el.pause();
};
btnPrev.onclick = ()=>{ cancelBreakIfAny(); prev(); };
btnNext.onclick = ()=>{ cancelBreakIfAny(); next(); };
btnLoop.onclick = ()=>{ audio.loop=!audio.loop; btnLoop.classList.toggle('onair', audio.loop); };

// Safe shuffle that keeps the current track pinned and avoids mid-load races
btnShuffle.onclick = ()=>{
  if (isShuffling || isLoading) return;
  isShuffling = true;

  const cur = PLAYLIST[idx];
  // Fisher‚ÄìYates
  for(let i=PLAYLIST.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [PLAYLIST[i],PLAYLIST[j]]=[PLAYLIST[j],PLAYLIST[i]];
  }
  // Pin current track
  const newIdx = PLAYLIST.findIndex(t => t === cur);
  if (newIdx !== -1){
    [PLAYLIST[newIdx], PLAYLIST[idx]] = [PLAYLIST[idx], PLAYLIST[newIdx]];
  }
  renderList(); markActive();

  // If a break is playing, do nothing else; otherwise keep playback uninterrupted.
  isShuffling = false;
};

btnMute.onclick = ()=>{
  const m=!currentMedia().muted;
  audio.muted=m; breakAudio.muted=m;
  btnMute.classList.toggle('onair', m);
};
vol.oninput = e => { audio.volume=+e.target.value; breakAudio.volume=+e.target.value; };

seek.oninput = ()=>{ userScrubbing=true; };
seek.onchange = e => {
  if(!isFinite(audio.duration)) { userScrubbing=false; return; }
  audio.currentTime = audio.duration*(+e.target.value/100);
  userScrubbing=false;
};

btnShare.onclick = async ()=>{
  const tr = PLAYLIST[idx];
  const url = new URL(location.href); url.searchParams.set('t', idx);
  const shareData = { title:'Listen with me ‚Äî KZAK', text: tr.title, url: url.toString() };
  try{
    if(navigator.share) await navigator.share(shareData);
    else throw 0;
  }catch{
    try{ await navigator.clipboard.writeText(url.toString()); alert('Link copied to clipboard!'); }
    catch{ location.href = `mailto:?subject=${encodeURIComponent('Listen ‚Äî '+tr.title)}&body=${encodeURIComponent(url.toString())}`; }
  }
};

/* ===== Main audio events ===== */
audio.addEventListener('play',  ()=>{ setOnAir(true);  btnPlay.textContent='‚è∏Ô∏é Pause';  meta.textContent='Playing'; });
audio.addEventListener('pause', ()=>{
  // If a break immediately starts, the lamp will be set by breakAudio 'play'
  if (!isBreak){ setOnAir(false); btnPlay.textContent='‚ñ∂Ô∏é Start Station'; meta.textContent='Paused'; }
});
audio.addEventListener('ended', ()=>{
  setOnAir(false);
  meta.textContent='Finished';
  if (pickBreakNow()) playBreakThenNext(); else next();
});
audio.addEventListener('timeupdate', ()=>{
  if(!userScrubbing && isFinite(audio.duration)){
    seek.value=(audio.currentTime/audio.duration)*100;
    document.getElementById('elapsed').textContent = fmt(audio.currentTime);
    document.getElementById('remaining').textContent = '-' + fmt(Math.max(0,(audio.duration - audio.currentTime)));
  }
});

/* ===== Break events (mirror lamp state) ===== */
breakAudio.addEventListener('play', ()=> setOnAir(true));
breakAudio.addEventListener('pause',()=> setOnAir(false));

/* ===== Init ===== */
(function init(){
  renderList();
  const p = parseInt(new URL(location.href).searchParams.get('t'),10);
  const startIdx = Number.isFinite(p) ? Math.max(0, Math.min(PLAYLIST.length-1, p)) : 0;
  load(startIdx, /*autoplay=*/false);
})();
</script>

</body>
</html>
