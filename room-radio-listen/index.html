 <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KZAK ‚Ä¢ Frasier-Style Free Radio without the talking</title>
<style>
  :root{
    --ink:#e6e9ef; --muted:#9aa4b2; --brand:#89b4fa; --accent:#a6e3a1; --danger:#f38ba8;
    --card:#151a29; --line:#22324d; --shadow:0 18px 50px rgba(0,0,0,.45);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:#0a0e1a;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* Lighter overlay so the background image pops more */
  .bg{
    position:fixed; inset:0; pointer-events:none;
    background:
      linear-gradient(180deg, rgba(10,14,26,.35), rgba(10,14,26,.70)),
      url('Media/RadioMusicListening.jpg') center/cover no-repeat;
    opacity:.38;
    filter:saturate(.95);
  }

 

 <div id="netBanner" class="net-banner" role="status" aria-live="polite" hidden>
  Offline ‚Äî reconnecting‚Ä¶ playback paused.
</div>

  .wrap{position:relative;max-width:1200px;margin:0 auto;padding:22px 18px 80px}

  header{display:flex;align-items:center;gap:12px;margin-bottom:14px}
  .header-logo{height:52px;border-radius:8px}
  h1{font-size:clamp(22px,3.4vw,36px);margin:0;line-height:1.15}
  .sub{opacity:.75;font-weight:500}

  /* ON AIR pill */
  .onair{display:inline-flex;align-items:center;gap:10px;background:#0f1626;border:1px solid var(--line);
         padding:8px 14px;border-radius:999px;box-shadow:var(--shadow)}
  .lamp{width:14px;height:14px;border-radius:50%;background:#263142;box-shadow:0 0 0 0 rgba(255,0,0,0);}
  .onair.active .lamp{background:#ff3647;box-shadow:0 0 18px 3px rgba(255,54,71,.6)}
  .onair .txt{letter-spacing:.25em;font-weight:700}

  /* Panels */
  .grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
  .panel{background:rgba(9,14,22,.66);backdrop-filter:blur(8px);border:1px solid var(--line);border-radius:16px;
         box-shadow:var(--shadow)}
  .panel .head{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
  .panel .body{padding:14px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  button, .btn{appearance:none;border:1px solid var(--line);background:#0f1626;color:var(--ink);
               padding:8px 12px;border-radius:12px;font-weight:600;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:6px}
  button:hover, .btn:hover{border-color:#2b3c5b}
  .btn.small{padding:6px 10px;font-size:.92rem}
  .btn.ghost{background:transparent}
  .btn.onair{background:#202a40}
  .spacer{flex:1}
  .kv{display:flex;align-items:center;gap:10px;font-size:.95rem}
  .kv input[type="range"]{width:160px}

  /* Prominent lobby button */
  .btn.lobby{
    background:var(--brand);
    color:#0a0e1a;
    border-color:#6e9fe7;
    padding:10px 14px;
    font-weight:800;
    border-radius:999px;
    box-shadow:0 8px 24px rgba(137,180,250,.25);
  }
  .btn.lobby:focus{outline:3px solid #cfe1ff; outline-offset:2px}

  .trackmeta{margin-top:10px;display:flex;align-items:center;gap:10px}
  #title{font-weight:700}
  #meta{opacity:.75}
  .bar{display:flex;align-items:center;gap:10px;margin-top:10px}
  .bar .time{min-width:44px;text-align:right;opacity:.8;font-feature-settings:"tnum" 1}
  .bar input[type="range"]{flex:1}

  /* Playlist */
  .list{max-height:540px;overflow:auto;padding:10px 8px 12px}
  .track{display:grid;grid-template-columns:40px 1fr;gap:10px;padding:8px;border-radius:10px;cursor:pointer}
  .track:hover{background:#101a2e}
  .idx{width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--line);
       border-radius:8px;font-weight:700}
  .idx.now{background:#1a2844;border-color:#34507e;color:#bcd3ff}
  .small{opacity:.65;font-size:.9rem}
  .hint{opacity:.7;font-size:.9rem;padding:0 12px 12px}

  /* Footer bios */
  .bio{display:grid;grid-template-columns:72px 1fr;gap:14px;align-items:center;padding:12px 14px}
  .bio img{width:72px;height:72px;border-radius:14px;border:1px solid var(--line);object-fit:cover}
  .bio .name{font-weight:800}
  .bio .role{opacity:.75}

  /* Tiny toast for load errors */
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
         background:#1b2438;border:1px solid #3b4f78;border-radius:10px;color:#e3ecff;
         padding:10px 14px;box-shadow:var(--shadow);font-size:.95rem;z-index:9999;display:none}
  .toast.show{display:block}

  @media (max-width:1024px){
    .grid{grid-template-columns:1fr}
    .list{max-height:360px}
  }
</style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="wrap">
    <header>
      <img class="header-logo" src="Media/frasier.png" alt="">
      <div>
        <h1>KZAK ‚Ä¢ Frasier-Style Free Radio without the talking</h1>
        <div class="sub">Larger controls ‚Ä¢ ON AIR lamp ‚Ä¢ Station ID every 3 songs ‚Ä¢ Share deep links</div>
      </div>
      <div class="spacer"></div>

      <!-- Prominent Return to Lobby button (same tab) -->
      <a href="../index.html"
         id="btnLobby"
         class="btn lobby"
         aria-label="Return to Museum Lobby">‚Üê Lobby</a>

      <div id="onAir" class="onair" aria-live="polite" style="margin-left:8px">
        <span id="onLamp" class="lamp"></span>
        <span class="txt">ON&nbsp;AIR</span>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Player -->
      <section class="panel">
        <div class="head">
          <div class="controls">
            <button id="btnPrev">‚óÄÔ∏é Prev</button>
            <button id="btnPlay">‚ñ∂Ô∏é Start Station</button>
            <button id="btnNext">Next ‚ñ∂Ô∏é</button>
            <button id="btnLoop" class="btn ghost">‚ü≤ Loop</button>
            <button id="btnShuffle" class="btn ghost">üîÄ Shuffle</button>
            <button id="btnMute" class="btn ghost">üîá Mute</button>
          </div>
          <div class="spacer"></div>
          <div class="kv">
            <span>Vol</span>
            <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9" />
          </div>
        </div>

        <div class="body">
          <div class="bar">
            <span class="time" id="elapsed">0:00</span>
            <input id="seek" type="range" min="0" max="100" value="0" />
            <span class="time" id="remaining">-0:00</span>
          </div>

          <div class="trackmeta">
            <div id="title">Station ID ‚Ä¢ KZAK</div>
            <span>‚Äî</span>
            <span id="meta">Not playing</span>
            <span class="spacer"></span>
            <span>TRACK <span id="tpos">1</span> / <span id="ttotal">0</span></span>
          </div>

          <div style="margin-top:12px">
            <button id="btnShare" class="btn small">Share</button>
          </div>

          <audio id="audio" crossorigin="anonymous" preload="auto"></audio>
        </div>
      </section>

      <!-- Right: Playlist -->
      <aside class="panel">
        <div class="head"><strong>Playlist</strong></div>
        <div id="list" class="list"></div>
        <div class="hint">
          Use headphones ‚Ä¢ Filenames are case-sensitive ‚Ä¢ Share copies a deep link to the current track
        </div>
      </aside>
    </div>

    <!-- Footer bios -->
    <section class="panel" style="margin-top:16px">
      <div class="bio">
        <img src="Media/ZachArt.jpeg" alt="">
        <div>
          <div class="name">zdjimas</div>
          <div class="role">Concept, curation, engineering</div>
        </div>
      </div>
      <div class="bio" style="border-top:1px solid var(--line)">
        <img src="Media/CJMURPHY.png" alt="">
        <div>
          <div class="name">cjmurphy</div>
          <div class="role">Composition, arrangement, sound design</div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Config ===== */
const LOAD_TIMEOUT_MS = 8000; // fall-forward if a track doesn‚Äôt load
const pathToUrl = p => encodeURI(p).replace(/#/g,'%23'); // keep spaces/() and escape #

/* ===== Helpers ===== */
const fmt = s => { if (!isFinite(s)) return '0:00'; const m=(s/60)|0, sec=(s%60)|0; return m+':'+(sec<10?'0':'')+sec; };
const pick = arr => arr[Math.floor(Math.random()*arr.length)];
const showToast = msg => {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> el.classList.remove('show'), 3000);
};

/* ===== DOM ===== */
const audio = document.getElementById('audio');
const btnPrev = document.getElementById('btnPrev');
const btnPlay = document.getElementById('btnPlay');
const btnNext = document.getElementById('btnNext');
const btnLoop = document.getElementById('btnLoop');
const btnShuffle = document.getElementById('btnShuffle');
const btnMute = document.getElementById('btnMute');
const btnShare = document.getElementById('btnShare');
const vol = document.getElementById('vol');
const seek = document.getElementById('seek');
const title = document.getElementById('title');
const meta = document.getElementById('meta');
const list = document.getElementById('list');
const onAir = document.getElementById('onAir');
const onLamp = document.getElementById('onLamp');
const tpos = document.getElementById('tpos');
const ttotal = document.getElementById('ttotal');

/* ===== PLAYLIST (exactly your 111 items) ===== */
const PLAYLIST = [
  { title: "Degrees (Cover)3 (Spanish guitar quartet )", file: "Media/Degrees (Cover)3 (Spanish guitar quartet ).mp3" },
  { title: "Lateralus Rising", file: "Media/Lateralus Rising.mp3" },
  { title: "01 Vicarious (Remix) 1", file: "Media/01 Vicarious (Remix) 1.mp3" },
  { title: "01. Sheep (cover)5", file: "Media/01. Sheep (cover)5.mp3" },
  { title: "01. The Grudge (Remastered)", file: "Media/01. The Grudge (Remastered).mp3" },
  { title: "03. Dogs (Cover) X2 tripper", file: "Media/03. Dogs (Cover) X2 tripper.mp3" },
  { title: "03. Dogs (Remix)", file: "Media/03. Dogs (Remix).mp3" },
  { title: "05. Pigs (Three Different Ones) (Techno Tran)", file: "Media/05. Pigs (Three Different Ones) (Techno Tran).mp3" },
  { title: "06 Another Brick In The Wall p2 2 (Cover ZZ) v2", file: "Media/06 Another Brick In The Wall p2 2 (Cover ZZ) v2.mp3" },
  { title: "07 Goodbye Blue Sky (cover zz) 2", file: "Media/07 Goodbye Blue Sky (cover zz) 2.mp3" },
  { title: "08 4 Degrees (Cover)2", file: "Media/08 4 Degrees (Cover)2.mp3" },
  { title: "08 4 Degrees (Cover)v1", file: "Media/08 4 Degrees (Cover)v1.mp3" },
  { title: "08 Rosetta Stoned (Cover) take 1", file: "Media/08 Rosetta Stoned (Cover) take 1.mp3" },
  { title: "10 Right In Two (Remastered) (Cover) (1)", file: "Media/10 Right In Two (Remastered) (Cover) (1).mp3" },
  { title: "10 Right In Two (Remastered) (Cover)", file: "Media/10 Right In Two (Remastered) (Cover).mp3" },
  { title: "10. Shine On You Crazy Diamond (Parts 6-9) (cover) (Remix)", file: "Media/10. Shine On You Crazy Diamond (Parts 6-9) (cover) (Remix).mp3" },
  { title: "10. Shine On You Crazy Diamond (Parts 6-9) (cover)", file: "Media/10. Shine On You Crazy Diamond (Parts 6-9) (cover).mp3" },
  { title: "11. Pushit (Cover) v2", file: "Media/11. Pushit (Cover) v2.mp3" },
  { title: "11. Reflection (Cover) V2", file: "Media/11. Reflection (Cover) V2.mp3" },
  { title: "14 - Any Colour You Like (Live 1972)", file: "Media/14 - Any Colour You Like (Live 1972).mp3" },
  { title: "1984-06-18 - Piano Resolo - 107 Keyboard Solo (Remix)", file: "Media/1984-06-18 - Piano Resolo - 107 Keyboard Solo (Remix).mp3" },
  { title: "46 & 3", file: "Media/46 & 3.mp3" },
  { title: "A Classical Aspect of X", file: "Media/A Classical Aspect of X .mp3" },
  { title: "A Demo in Time of Dying", file: "Media/A Demo in Time of Dying.mp3" },
  { title: "A Demo of Poor Tom", file: "Media/A Demo of Poor Tom.mp3" },
  { title: "A Madman Plays Seville", file: "Media/A Madman Plays Seville.mp3" },
  { title: "A Spec of a Blue Dot", file: "Media/A Spec of a Blue Dot.mp3" },
  { title: "All that glitters is gold Acoustic Blend", file: "Media/All that glitters is gold Acoustic Blend.mp3" },
  { title: "All that glitters is gold remains", file: "Media/All that glitters is gold remains.mp3" },
  { title: "All that glitters is gold", file: "Media/All that glitters is gold.mp3" },
  { title: "Another Dogs Cover - Really?", file: "Media/Another Dogs Cover - Really?.mp3" },
  { title: "As I Am (Instrumental Demo 2003) (cover zz2)", file: "Media/As I Am (Instrumental Demo 2003) (cover zz2).mp3" },
  { title: "Ballad of a Bleak Future", file: "Media/Ballad of a Bleak Future.mp3" },
  { title: "Barn Jam Friends", file: "Media/Barn Jam Friends.mp3" },
  { title: "Bend the clock - 70s Barn Jam Edition", file: "Media/Bend the clock - 70s Barn Jam Edition.mp3" },
  { title: "Beyond My Understanding", file: "Media/Beyond My Understanding.mp3" },
  { title: "Bolotone Desert Trip Edition", file: "Media/Bolotone Desert Trip Edition.mp3" },
  { title: "Bolotone Metal Edition (Remastered)", file: "Media/Bolotone Metal Edition (Remastered).mp3" },
  { title: "Bolotone's Intro", file: "Media/Bolotone's Intro.mp3" },
  { title: "Breathe - (an AI pink floyd cover)", file: "Media/Breathe - (an AI pink floyd cover).mp3" },
  { title: "Continuum - an Octavarium Remix and Cover", file: "Media/Continuum - an Octavarium Remix and Cover.mp3" },
  { title: "Cover Of Wings For Marie (Part 1) v1", file: "Media/Cover Of Wings For Marie (Part 1) v1.mp3" },
  { title: "Cover Wings For Marie (Part 1) (Spanish acoustic ) (1)", file: "Media/Cover Wings For Marie (Part 1) (Spanish acoustic ) (1).mp3" },
  { title: "Cover of Tool - 7empest 1", file: "Media/Cover of Tool - 7empest 1.mp3" },
  { title: "Cover of Tool - 7empest 2", file: "Media/Cover of Tool - 7empest 2.mp3" },
  { title: "Cover of Wings For Marie (Part 1) v2", file: "Media/Cover of Wings For Marie (Part 1) v2.mp3" },
  { title: "Cover. The Grudge (v2)", file: "Media/Cover. The Grudge (v2).mp3" },
  { title: "Covering my Eyes", file: "Media/Covering my Eyes.mp3" },
  { title: "Culling Voices Gathered in Flocks", file: "Media/Culling Voices Gathered in Flocks.mp3" },
  { title: "Culling Voices Gathering Alone", file: "Media/Culling Voices Gathering Alone.mp3" },
  { title: "Degrees (Cover)3 (Spanish guitar quartet)", file: "Media/Degrees (Cover)3 (Spanish guitar quartet).mp3" },
  { title: "Dogs (Remix)", file: "Media/Dogs (Remix).mp3" },
  { title: "Dogs Cover 2 Funky", file: "Media/Dogs Cover 2 Funky.mp3" },
  { title: "Fear Inoculum (Cover) v1", file: "Media/Fear Inoculum (Cover) v1.mp3" },
  { title: "Fear Inoculum - Hip Beat Remix", file: "Media/Fear Inoculum - Hip Beat Remix.mp3" },
  { title: "Fear Inoculum - Intro remix", file: "Media/Fear Inoculum - Intro remix.mp3" },
  { title: "Flood an AI Tool Cover", file: "Media/Flood an AI Tool Cover.mp3" },
  { title: "Friends in FrontierLand", file: "Media/Friends in FrontierLand.mp3" },
  { title: "Hiding the Pot (1)", file: "Media/Hiding the Pot (1).mp3" },
  { title: "Home Again.", file: "Media/Home Again..mp3" },
  { title: "Labyrinths of Coral Caves", file: "Media/Labyrinths of Coral Caves .mp3" },
  { title: "Leaving You", file: "Media/Leaving You.mp3" },
  { title: "More Guitars at Luna Park", file: "Media/More Guitars at Luna Park.mp3" },
  { title: "My Broken Illusion (1)", file: "Media/My Broken Illusion (1).mp3" },
  { title: "New Beginnings", file: "Media/New Beginnings.mp3" },
  { title: "Octavarium en Quartet", file: "Media/Octavarium en Quartet.mp3" },
  { title: "Orchestra for Wings For Marie (Cover) take 7", file: "Media/Orchestra for Wings For Marie (Cover) take 7.mp3" },
  { title: "Our Waiting for Sleep, an instrumental", file: "Media/Our Waiting for Sleep, an instrumental.mp3" },
  { title: "Pigs three different ones Solo (Cover)2b", file: "Media/Pigs three different ones Solo (Cover)2b.mp3" },
  { title: "Rain Song Replayed", file: "Media/Rain Song Replayed.mp3" },
  { title: "Rosetta must be Stoned", file: "Media/Rosetta must be Stoned.mp3" },
  { title: "Running from Waiting Worms", file: "Media/Running from Waiting Worms.mp3" },
  { title: "S2N an AI Cover of Dream Theater (Remix)", file: "Media/S2N an AI Cover of Dream Theater (Remix).mp3" },
  { title: "Schism (Cover)v1", file: "Media/Schism (Cover)v1.mp3" },
  { title: "Shine On (Cover) 5 (Remastered)", file: "Media/Shine On (Cover) 5 (Remastered).mp3" },
  { title: "Shine On You Crazy Diamond - Lap steel guitar Edition (Cover Z2Z))", file: "Media/Shine On You Crazy Diamond - Lap steel guitar Edition (Cover Z2Z)).mp3" },
  { title: "Surfacing Tensions", file: "Media/Surfacing Tensions.mp3" },
  { title: "Surrounded by Friends", file: "Media/Surrounded by Friends.mp3" },
  { title: "TechnoTrance The Pot V1", file: "Media/TechnoTrance The Pot V1.mp3" },
  { title: "TechnoTrance The Pot V2", file: "Media/TechnoTrance The Pot V2.mp3" },
  { title: "The Modern Count of Tuscany (Remastered)", file: "Media/The Modern Count of Tuscany (Remastered).mp3" },
  { title: "The Canelo-Crawford Event Round 1", file: "Media/The Canelo-Crawford Event Round 1.mp3" },
  { title: "The Canelo-Crawford Event", file: "Media/The Canelo-Crawford Event.mp3" },
  { title: "The Greatest Debate Ever", file: "Media/The Greatest Debate Ever.mp3" },
  { title: "The Madman Plays in Cancun", file: "Media/The Madman Plays in Cancun.mp3" },
  { title: "The Ones Who Help to Set the Sun (Cover ZZ 4 Demo) (Remix)", file: "Media/The Ones Who Help to Set the Sun (Cover ZZ 4 Demo) (Remix).mp3" },
  { title: "The Recovering Barstool Warrior", file: "Media/The Recovering Barstool Warrior.mp3" },
  { title: "The Spirit Carries On (Live Rehearsal 2) (Remix)", file: "Media/The Spirit Carries On (Live Rehearsal 2) (Remix).mp3" },
  { title: "The Strangest of Days", file: "Media/The Strangest of Days.mp3" },
  { title: "The X Aspect Symphony Remix", file: "Media/The X Aspect Symphony Remix.mp3" },
  { title: "The X Aspect shortened", file: "Media/The X Aspect shortened.mp3" },
  { title: "TheHumblingRiver = a Cover", file: "Media/TheHumblingRiver = a Cover.mp3" },
  { title: "Tool - No Quarter (FULL HD) (Remastered) (Cover ZZ)", file: "Media/Tool - No Quarter (FULL HD) (Remastered) (Cover ZZ).mp3" },
  { title: "Trippin like Hell", file: "Media/Trippin like Hell.mp3" },
  { title: "When Pigs and Sheep Mate IV.", file: "Media/When Pigs and Sheep Mate IV..mp3" },
  { title: "Wings For Marie (Part 1) (Techno Trance Remix) v2", file: "Media/Wings For Marie (Part 1) (Techno Trance Remix) v2.mp3" },
  { title: "X11 10,000 Days Live (Cover ZZ) (Remastered)", file: "Media/X11 10,000 Days Live (Cover ZZ) (Remastered).mp3" },
  { title: "ozzy osbourne diary of a madman rare live (Remix)", file: "Media/ozzy osbourne diary of a madman rare live (Remix).mp3" },
  { title: "‚ÄúThe Embracing Circle‚Äù - cover take 3", file: "Media/‚ÄúThe Embracing Circle‚Äù - cover take 3.mp3" },
  { title: "‚ÄúThe Embracing Circle‚Äù - extrat from Illumination Theory, Dream Theater-2", file: "Media/‚ÄúThe Embracing Circle‚Äù - extrat from Illumination Theory, Dream Theater-2.mp3" },
  { title: "‚ÄúThe Embracing Circle‚Äù - extrat from Illumination Theory, Dream Theater-3", file: "Media/‚ÄúThe Embracing Circle‚Äù - extrat from Illumination Theory, Dream Theater-3.mp3" },
  { title: "‚ÄúThe Embracing Circle‚Äù - extrat from Illumination Theory, Dream Theater", file: "Media/‚ÄúThe Embracing Circle‚Äù - extrat from Illumination Theory, Dream Theater.mp3" }
];

ttotal.textContent = PLAYLIST.length;

/* ===== Station IDs (separate folder) ===== */
const BREAKS = [
  "MediaBreaks/AishaPatelYouarelisteningtoK-Z-A-K.wav",
  "MediaBreaks/AmyYouarelisteningtoK-ZACHt.mp3",
  "MediaBreaks/en-US-Journey-D-K_ZACH___where_the_f.wav",
  "MediaBreaks/en-US-Journey-DYouaretunedintoK-Z-A-Kb.mp3",
  "MediaBreaks/en-US-News-NThisiskZ-A-Kbringingyou.mp3"
];
const BREAKS_CFG = { enabled:true, mode:"everyN", n:3, prob:0.33 };

/* ===== State ===== */
let idx = 0;
let userScrubbing = false;
let isBreak = false;
let tracksSinceBreak = 0;
let isLoading = false;    // guard async races (load/shuffle/ended)
let isShuffling = false;  // avoid re-entrancy
let loadTimer = null;     // timeout guard per track

/* Separate audio element just for breaks */
const breakAudio = new Audio();
breakAudio.crossOrigin = 'anonymous';

/* ===== UI helpers ===== */
function setOnAir(on){ onAir.classList.toggle('active', on); }
function pickBreakNow(){
  if (!BREAKS_CFG.enabled || audio.loop || BREAKS.length===0) return false;
  if (BREAKS_CFG.mode==="everyN"){ tracksSinceBreak++; if (tracksSinceBreak>=BREAKS_CFG.n){ tracksSinceBreak=0; return true; } return false; }
  if (BREAKS_CFG.mode==="betweenAll") return true;
  if (BREAKS_CFG.mode==="random") return Math.random() < BREAKS_CFG.prob;
  return false;
}
function currentMedia(){ return isBreak ? breakAudio : audio; }

/* ===== Playlist UI ===== */
function renderList(){
  list.innerHTML='';
  PLAYLIST.forEach((t,i)=>{
    const row=document.createElement('div');
    row.className='track';
    row.innerHTML=`<span class="idx">${String(i+1).padStart(2,'0')}</span>
                   <div><div>${t.title}</div><div class="small">${t.file.replace(/^Media\//,'')}</div></div>`;
    row.onclick=()=>{ cancelBreakIfAny(); load(i, /*autoplay=*/true); };
    list.appendChild(row);
  });
}
function markActive(){
  [...list.children].forEach((el,i)=>el.querySelector('.idx').classList.toggle('now', i===idx));
}

/* ===== Core playback with robust error/timeout handling ===== */
function clearLoadTimer(){ if (loadTimer){ clearTimeout(loadTimer); loadTimer = null; } }

function load(i, autoplay=false){
  isLoading = true;
  clearLoadTimer();

  idx = (i+PLAYLIST.length)%PLAYLIST.length;
  const tr = PLAYLIST[idx];
  const src = pathToUrl(tr.file);

  audio.src = src;
  title.textContent = tr.title;
  meta.textContent = 'Queued';
  tpos.textContent = idx+1;
  markActive();

  const u=new URL(location); u.searchParams.set('t', idx); history.replaceState({},'',u);

  // reset scrubber
  seek.value = 0;
  document.getElementById('elapsed').textContent = '0:00';
  document.getElementById('remaining').textContent = '-0:00';

  // Start timer: if we don't get metadata in time, skip
  loadTimer = setTimeout(()=>{
    console.warn('Load timeout for', tr.file);
    showToast('Skipping: could not load ‚Äú' + tr.title + '‚Äù');
    isLoading = false;
    next(); // fail-forward
  }, LOAD_TIMEOUT_MS);

  const onReady = () => {
    clearLoadTimer();
    isLoading = false;
    if (autoplay) play();
  };

  if (audio.readyState >= 2) onReady();
  else {
    audio.onloadedmetadata = onReady;
    // Also react if we can start earlier
    audio.oncanplay = ()=>{ /* nothing; wait for metadata or timeout */ };
  }
}

function play(){
  if (isBreak) { cancelBreakIfAny(); next(); return; }
  audio.play().catch((err)=>{
    console.error('Play error for', PLAYLIST[idx]?.file, err);
    showToast('Playback error ‚Äî skipping');
    next();
  });
}
function pause(){ currentMedia().pause(); }
function next(){ load(idx+1, /*autoplay=*/true); }
function prev(){ load(idx-1, /*autoplay=*/true); }

/* ===== Break handling ===== */
function cancelBreakIfAny(){
  if (isBreak){
    try { breakAudio.pause(); } catch {}
    isBreak=false;
  }
}
async function playBreakThenNext(){
  if (audio.loop) { next(); return; } // skip breaks under Loop
  isBreak = true;
  const prevTitle=title.textContent, prevMeta=meta.textContent;

  breakAudio.volume = audio.volume;
  breakAudio.muted  = audio.muted;
  const file = pick(BREAKS);
  title.textContent = "Station ID ‚Ä¢ KZAK";
  meta.textContent = file.replace(/^MediaBreaks\//,'');
  breakAudio.src = pathToUrl(file);

  const goNext = () => { title.textContent=prevTitle; meta.textContent=prevMeta; isBreak=false; next(); };
  breakAudio.onerror = (e)=>{ console.error('Break load error', file, e); goNext(); };
  breakAudio.onended = goNext;

  try{ await breakAudio.play(); }catch(err){ console.error('Break play error', err); goNext(); }
}

/* ===== Controls ===== */
btnPlay.onclick = ()=>{ if (isBreak){ cancelBreakIfAny(); next(); return; } const el=currentMedia(); el.paused?el.play().catch(()=>{}):el.pause(); };
btnPrev.onclick = ()=>{ cancelBreakIfAny(); prev(); };
btnNext.onclick = ()=>{ cancelBreakIfAny(); next(); };
btnLoop.onclick = ()=>{ audio.loop=!audio.loop; btnLoop.classList.toggle('onair', audio.loop); };

// Safe shuffle: pin current track; avoid mid-load races; don't interrupt break
btnShuffle.onclick = ()=>{
  if (isShuffling || isLoading) return;
  isShuffling = true;
  const cur = PLAYLIST[idx];
  for(let i=PLAYLIST.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [PLAYLIST[i],PLAYLIST[j]]=[PLAYLIST[j],PLAYLIST[i]]; }
  const newIdx = PLAYLIST.findIndex(t => t === cur);
  if (newIdx !== -1){ [PLAYLIST[newIdx], PLAYLIST[idx]] = [PLAYLIST[idx], PLAYLIST[newIdx]]; }
  renderList(); markActive();
  isShuffling = false;
};

btnMute.onclick = ()=>{ const m=!currentMedia().muted; audio.muted=m; breakAudio.muted=m; btnMute.classList.toggle('onair', m); };
vol.oninput = e => { audio.volume=+e.target.value; breakAudio.volume=+e.target.value; };

seek.oninput = ()=>{ userScrubbing=true; };
seek.onchange = e => { if(!isFinite(audio.duration)) { userScrubbing=false; return; } audio.currentTime = audio.duration*(+e.target.value/100); userScrubbing=false; };

btnShare.onclick = async ()=>{
  const tr = PLAYLIST[idx];
  const url = new URL(location.href); url.searchParams.set('t', idx);
  const shareData = { title:'Listen with me ‚Äî KZAK', text: tr.title, url: url.toString() };
  try{
    if(navigator.share) await navigator.share(shareData);
    else throw 0;
  }catch{
    try{ await navigator.clipboard.writeText(url.toString()); alert('Link copied to clipboard!'); }
    catch{ location.href = `mailto:?subject=${encodeURIComponent('Listen ‚Äî '+tr.title)}&body=${encodeURIComponent(url.toString())}`; }
  }
};

/* ===== Main audio events ===== */
audio.addEventListener('play',  ()=>{ setOnAir(true);  btnPlay.textContent='‚è∏Ô∏é Pause';  meta.textContent='Playing'; });
audio.addEventListener('pause', ()=>{ if (!isBreak){ setOnAir(false); btnPlay.textContent='‚ñ∂Ô∏é Start Station'; meta.textContent='Paused'; } });

// If a track errors (404, decode error), skip it instead of hanging on "Queued"
audio.addEventListener('error', (e)=>{
  const tr = PLAYLIST[idx];
  console.error('Audio load error:', tr?.file, e);
  showToast('Skipping: could not load ‚Äú' + (tr?.title||'Track') + '‚Äù');
  clearLoadTimer();
  isLoading = false;
  next();
});

audio.addEventListener('ended', ()=>{
  setOnAir(false);
  meta.textContent='Finished';
  if (pickBreakNow()) playBreakThenNext(); else next();
});

audio.addEventListener('timeupdate', ()=>{
  if(!userScrubbing && isFinite(audio.duration)){
    seek.value=(audio.currentTime/audio.duration)*100;
    document.getElementById('elapsed').textContent = fmt(audio.currentTime);
    document.getElementById('remaining').textContent = '-' + fmt(Math.max(0,(audio.duration - audio.currentTime)));
  }
});

/* Reflect ON AIR during breaks too */
breakAudio.addEventListener('play', ()=> setOnAir(true));
breakAudio.addEventListener('pause',()=> setOnAir(false));

/* ===== Init ===== */
(function init(){
  renderList();
  const p = parseInt(new URL(location.href).searchParams.get('t'),10);
  const startIdx = Number.isFinite(p) ? Math.max(0, Math.min(PLAYLIST.length-1, p)) : 0;
  ttotal.textContent = PLAYLIST.length; // ensure counter shows the actual list size (79 currently)
  load(startIdx, /*autoplay=*/false);
})();
</script>
</body>
</html>
